###
# Copyright (2016-2017) Hewlett Packard Enterprise Development LP
#
# Licensed under the Apache License, Version 2.0 (the "License");
# You may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
###
---
- hosts: all
  vars:
    config: "{{ playbook_dir }}/oneview_config.json"
    storage_system_name: a-dcb-sto0100.ad.nublar.de #CODE Synergy-Nimble: 4
    storage_volume_template_name: ESX_Data_Volume_on_Nimble #CODE Synergy-Nimble:13
    rest_hostname: a-dcb-syn0001.ad.nublar.de #CODE aus oneview_config?
    rest_user: Administrator #CODE aus oneview_config?
    rest_pass: Concat123 #CODE aus oneview_config?
    rest_domain: LOCAL #CODE aus oneview_config?
    rest_api_version: 1000 #CODE aus oneview_config?

  tasks:
    - name: Find Storage System URI
      oneview_storage_system_facts:
        config: "{{ config }}"
        storage_hostname: "{{ storage_system_name }}"
    - set_fact: storage_system_uri="{{ storage_systems.uri }}"

    - set_fact: nimble_performance_policy="{{ item.id }}"
      when: item.name == "VMware ESX 5"
      with_items: "{{storage_systems.deviceSpecificAttributes.performancePolicies }}"
      no_log: True

    - name: Find Storage Pool URI
      oneview_storage_pool_facts:
        config: "{{ config }}"
    - set_fact: storage_pool_uri="{{ storage_pools.0.uri }}"

    - name: Login to API and retrieve AUTH-Token
      uri:
        headers:
          X-Api-Version: "{{ rest_api_version }}"
          Content-Type: application/json
        url: "https://{{ rest_hostname }}/rest/login-sessions"
        method: POST
        body_format: json
        body:
          authLoginDomain: "{{ rest_domain }}"
          userName: "{{ rest_user }}"
          password: "{{ rest_pass }}"
          loginMsgAck: "true"
      register: var_this

    - set_fact: auth_token='{{ var_this["json"]["sessionID"] }}'

    - name: Retrieve Nimble root Volume Template URI
      uri:
        headers:
          X-Api-Version: "{{ rest_api_version }}"
          Content-Type: application/json
          Auth: "{{ auth_token }}"
        url: "https://{{ rest_hostname }}/{{ storage_system_uri }}/templates?query=isRoot%20EQ%20true"
        method: GET
      register: root_template
    - set_fact: root_template_uri="{{ root_template.json.members[0].uri }}"

    - name: Create a Storage Volume Template
      oneview_storage_volume_template:
        config: "{{ config }}"
        state: present
        data:
          rootTemplateUri: "{{ root_template_uri }}"
          properties:
            name:
              meta:
                locked: false
              type: string
              title: Volume name
              required: true
              maxLength: 100
              minLength: 1
              description: A volume name between 1 and 100 characters
            size:
              meta:
                locked: false
                semanticType: capacity
              type: integer
              title: Capacity
              default: 8796093022208
              maximum: 139637976727552
              minimum: 1048576
              required: true
              description: Capacity of the volume in bytes
            folder:
              meta:
                locked: true
                semanticType: device-folder
              type: string
              title: Folder
              default: 
              required: false
              description: Nimble identifier of the folder which will contain the volume
            isPinned:
              meta:
                locked: true
              type: boolean
              title: Is Volume Cache Pinning enabled
              default: false
              required: false
              description: Enables or disables volume cache pinning for the volume
            iopsLimit:
              meta:
                locked: true
              type: integer
              title: Maximum Input/Output Operations per Second
              default: 
              maximum: 4294967294
              minimum: 256
              required: false
              description: Specifies the maximum input/output operations per second for the
                volume
            volumeSet:
              meta:
                locked: true
                semanticType: device-volume-collection
              type: string
              title: Volume Set
              format: x-uri-reference
              default: 
              required: false
              description: URI of the volume set to associate with the volume
            description:
              meta:
                locked: false
              type: string
              title: Description
              default: ''
              required: false
              maxLength: 2000
              minLength: 0
              description: A description for the volume
            isEncrypted:
              meta:
                locked: true
                createOnly: true
              type: boolean
              title: Is Encryption enabled
              default: false
              required: false
              description: Enables or disables encryption of the volume
            isShareable:
              meta:
                locked: false
              type: boolean
              title: Is Shareable
              default: true
              required: false
              description: The shareability of the volume
            storagePool:
              meta:
                locked: false
                createOnly: true
                semanticType: device-storage-pool
              type: string
              title: Storage Pool
              format: x-uri-reference
              required: true
              description: URI of the Storage Pool the volume should be added to
              default: "{{ storage_pool_uri }}"
            isDeduplicated:
              meta:
                locked: true
              type: boolean
              title: Is Deduplication enabled
              default: true
              required: false
              description: Enables or disables deduplication of the volume
            templateVersion:
              meta:
                locked: true
              type: string
              title: Template version
              default: '1.0'
              required: true
              description: Version of the template
            provisioningType:
              enum:
              - Thin
              - Full
              meta:
                locked: true
                createOnly: true
                semanticType: device-provisioningType
              type: string
              title: Provisioning Type
              default: Thin
              required: false
              description: The provisioning type for the volume
            dataTransferLimit:
              meta:
                locked: true
              type: integer
              title: Data Transfer Limit Maximum in mebibytes
              default: 
              maximum: 4294967294
              minimum: 1
              required: false
              description: Specifies the maximum data transfer limit for the volume
            performancePolicy:
              meta:
                locked: true
                semanticType: device-performancePolicy
              type: string
              title: Performance Policy
              required: true
              description: Nimble identifier of the performance policy to associate with the
                volume
              default: "{{ nimble_performance_policy }}"
          name: "{{ storage_volume_template_name }}"
          description: ''

